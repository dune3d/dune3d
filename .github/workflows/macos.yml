name: Build macOS binaries

on:
  push:
    branches:
      - '**'
      - '!appveyor-*'
      - '!freebsd-*'
      - '!pr-review*'
    tags: [ '*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
    - name: Check tag
      if: startsWith(github.ref, 'refs/tags/')
      run: echo "Building tag ${{ github.ref }}"
    - uses: actions/checkout@v4
    - name: Unbreak python in github actions
      run: |
        find /usr/local/bin -lname '*/Library/Frameworks/Python.framework/*' -delete
        sudo rm -rf /Library/Frameworks/Python.framework/
        brew install --force python3 && brew unlink python3 && brew unlink python3 && brew link --overwrite python3
    - name: Install
      shell: bash
      run: |
        brew install \
          llvm \
          eigen \
          opencascade \
          pkg-config \
          gtk4 \
          gtkmm4 \
          glm \
          range-v3 \
          mimalloc \
          pygobject3 \
          librsvg

        # the stable meson version seems to crash with the cmake dependency
        brew install --HEAD meson
    - name: Build
      shell: bash
      run: |
        # use the cross file based on the architecture, we assume homebrew installs packages in /usr/local on x86_64 and /opt/homebrew on arm64
        meson setup --cross-file macos-$(uname -m).ini build

        meson compile -C build
